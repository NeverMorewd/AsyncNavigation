name: Pack & Publish NuGet Packages

on:
  workflow_dispatch:

jobs:
  # 1️⃣ Abstraction
  nuget-abstraction:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.1

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: Build Abstraction
        run: dotnet build ./src/AsyncNavigation --configuration Release

      - name: Pack Abstraction NuGet
        run: dotnet pack ./src/AsyncNavigation --configuration Release --no-build -o ./nugets

      - name: List NuGet packages
        run: ls -la ./nugets

      - name: Publish NuGet package
        run: |
          if [ -n "$(find ./nugets -name '*.nupkg')" ]; then
            dotnet nuget push "./nugets/*.nupkg" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
          fi

      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v4.3.1
        with:
          name: nugets-abstraction
          path: ./nugets

  # 2️⃣ Avalonia
  nuget-avaloniaui:
    needs: nuget-abstraction
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.1

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: Build Avalonia
        run: dotnet build ./src/AsyncNavigation.Avalonia --configuration Release

      - name: Pack Avalonia NuGet
        run: dotnet pack ./src/AsyncNavigation.Avalonia --configuration Release --no-build -o ./nugets

      - name: List NuGet packages
        run: ls -la ./nugets

      - name: Publish NuGet package
        run: |
          if [ -n "$(find ./nugets -name '*.nupkg')" ]; then
            dotnet nuget push "./nugets/*.nupkg" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
          fi

      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v4.3.1
        with:
          name: nugets-abstraction
          path: ./nugets

  # 3️⃣ WPF
  nuget-wpf:
    needs: nuget-abstraction
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.1

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: Build WPF
        run: dotnet build ./src/AsyncNavigation.Wpf --configuration Release

      - name: Pack WPF NuGet
        run: dotnet pack ./src/AsyncNavigation.Wpf --configuration Release --no-build -o ./nugets

      - name: List NuGet packages
        shell: pwsh
        run: Get-ChildItem -Path "./nugets"

      - name: Publish NuGet package
        run: |
          if [ -n "$(find ./nugets -name '*.nupkg')" ]; then
            dotnet nuget push "./nugets/*.nupkg" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
          fi

      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v4.3.1
        with:
          name: nugets-abstraction
          path: ./nugets
